package com.xywg.admin.modular.led.service.impl;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.service.impl.ServiceImpl;
import com.xywg.admin.modular.led.dao.UserProjectForLedMapper;
import com.xywg.admin.modular.led.model.AttendanceToLed;
import com.xywg.admin.modular.led.model.UploadUser;
import com.xywg.admin.modular.led.model.UserProjectForLed;
import com.xywg.admin.modular.led.service.UserProjectForLedService;
import com.xywg.admin.modular.smz.utils.ImageUtil;
import com.xywg.admin.modular.worker.service.IWorkerMasterService;

@SuppressWarnings("all")
@Service
public class UserProjectForLedServiceImpl extends ServiceImpl<UserProjectForLedMapper, UserProjectForLed> implements UserProjectForLedService {
	@Autowired
	UserProjectForLedMapper mapper;
	@Autowired
	IWorkerMasterService workerService;

	@Value("${spring.mvc.view.imageLocalPath}")
	private String imagePath;
	@Override
	public JSONObject getPrjectUserCount(JSONObject jsonIn) {
		Map mapIn=JSON.parseObject(jsonIn.toString());
		Integer projectUserCount = mapper.getPrjectUserCount(mapIn.get("projectName").toString());
		Map<String, Object> map = new HashMap<String, Object>(16);
		map.put("userCount", projectUserCount);
		JSONObject fromObject = JSONObject.fromObject(map);
		return fromObject;
	}

	@Override
	public void uploadUser(UploadUser uploadUser) {
		mapper.uploadUser(uploadUser);
	}

	@Override
	public JSONObject getUserInfoByIdToLed(JSONObject json) {
		Map map=JSON.parseObject(json.toString());
		String idCard=map.get("userId").toString();
		String projectName=map.get("projectName").toString();
		//查询人员信息
		UserProjectForLed userInfoByIdToLed = mapper.getUserInfoByIdToLed(projectName, idCard);
		if (userInfoByIdToLed != null) {
			//身份证照片转base64
			String photo = userInfoByIdToLed.getPhoto();
			try {
				userInfoByIdToLed.setPhoto(ImageUtil.GetImageStr(imagePath+ photo));
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		//转为json对象
		JSONObject fromObject = JSONObject.fromObject(userInfoByIdToLed);
		return fromObject;
	}

	@Override
	public JSONArray queryUserInfoByNameToLed(JSONObject json) {
		Map map=JSON.parseObject(json.toString());
		String projectName=map.get("projectName").toString();
		List<UserProjectForLed> list = mapper.queryUserInfoByNameToLed(projectName);
		//循环遍历修改图片
		for (UserProjectForLed userProjectForLed : list) {
			if (userProjectForLed.getPhoto() != null && userProjectForLed.getPhoto() != "") {
				try {
					userProjectForLed.setPhoto(ImageUtil.GetImageStr(imagePath + userProjectForLed.getPhoto()));
				} catch (Exception e) {
					System.out.println(userProjectForLed.getUserId());
					e.printStackTrace();
				}
			}else{
				userProjectForLed.setPhoto("");
			}
		}
		//转为json对象输出
		JSONArray fromObject = JSONArray.fromObject(list);
		return fromObject;
	}

	@Override
	public JSONArray queryUserInfoToLed() {
		List<UserProjectForLed> list = mapper.queryUserInfoToLed();
		//循环遍历修改图片
		for (UserProjectForLed userProjectForLed : list) {
			if (userProjectForLed.getPhoto() != null && userProjectForLed.getPhoto() != "") {
				try {
					userProjectForLed.setPhoto(ImageUtil.GetImageStr(imagePath + userProjectForLed.getPhoto()));
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}
		//转为json对象输出
		JSONArray fromObject = JSONArray.fromObject(list);
		return fromObject;
	}

	@Override
	public JSONObject getAttendanceByProjectNameToLed(JSONObject json) {
		Map map=JSON.parseObject(json.toString());
		String projectName=map.get("projectName").toString();
		AttendanceToLed attendanceToLed=new AttendanceToLed();
		attendanceToLed.setCount(mapper.getCountByProjectNameToLed(projectName));
		attendanceToLed.setRecord(mapper.getRecordByProjectNameToLed(projectName));
		JSONObject jsonObject = JSONObject.fromObject(attendanceToLed);
		return jsonObject;
	}

	@Override
	public JSONObject login() {
		Map<String, Object> map = new HashMap<String, Object>(16);
		map.put("code",200);
		JSONObject fromObject = JSONObject.fromObject(map);
		return  fromObject;
	}


}
