<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xywg.admin.modular.report.dao.DeviceReportMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.xywg.admin.modular.report.model.DeviceReport">
        <id column="id" property="id" />
        <result column="project_code" property="projectCode" />
        <result column="organization_code" property="organizationCode" />
        <result column="company_name" property="companyName" />
        <result column="id_card_type" property="idCardType" />
        <result column="id_card_number" property="idCardNumber" />
        <result column="worker_name" property="workerName" />
        <result column="project_name" property="projectName" />
        <result column="team_sys_no" property="teamSysNo" />
        <result column="team_name" property="teamName" />
        <result column="time" property="time" />
        <result column="total_count" property="totalCount" />
        <result column="total_date" property="totalDate" />
        <result column="day01" property="day01" />
        <result column="day02" property="day02" />
        <result column="day03" property="day03" />
        <result column="day04" property="day04" />
        <result column="day05" property="day05" />
        <result column="day06" property="day06" />
        <result column="day07" property="day07" />
        <result column="day08" property="day08" />
        <result column="day09" property="day09" />
        <result column="day10" property="day10" />
        <result column="day11" property="day11" />
        <result column="day12" property="day12" />
        <result column="day13" property="day13" />
        <result column="day14" property="day14" />
        <result column="day15" property="day15" />
        <result column="day16" property="day16" />
        <result column="day17" property="day17" />
        <result column="day18" property="day18" />
        <result column="day19" property="day19" />
        <result column="day20" property="day20" />
        <result column="day21" property="day21" />
        <result column="day22" property="day22" />
        <result column="day23" property="day23" />
        <result column="day24" property="day24" />
        <result column="day25" property="day25" />
        <result column="day26" property="day26" />
        <result column="day27" property="day27" />
        <result column="day28" property="day28" />
        <result column="day29" property="day29" />
        <result column="day30" property="day30" />
        <result column="day31" property="day31" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, project_code AS projectCode, organization_code AS organizationCode, company_name AS companyName, id_card_type AS idCardType, id_card_number AS idCardNumber, worker_name AS workerName, project_name AS projectName, team_sys_no AS teamSysNo, team_name AS teamName, time, total_count AS totalCount, total_date AS totalDate, day01, day02, day03, day04, day05, day06, day07, day08, day09, day10, day11, day12, day13, day14, day15, day16, day17, day18, day19, day20, day21, day22, day23, day24, day25, day26, day27, day28, day29, day30, day31,over_time AS overTime,total_time AS totalTime
    </sql>

	<!-- 查询 -->
	<select id="getDeviceReportBy5Fields" parameterType="com.xywg.admin.modular.report.model.DeviceReport" 
		resultType="com.xywg.admin.modular.report.model.DeviceReport">
		select
		<include refid="Base_Column_List"/>
		from buss_device_report
		where organization_code = #{d.organizationCode}
		and project_code = #{d.projectCode}
		<choose>
       		<when test="d.teamSysNo != null">
            	and team_sys_no = #{d.teamSysNo}
        	</when>
       	    <otherwise>
            	and team_sys_no is null
            </otherwise>
        </choose>
		and id_card_number = #{d.idCardNumber}
		and id_card_type = #{d.idCardType}
		and time = #{d.time}
	</select>
	
	<!-- 保存数据 -->
  	<insert id="saveDeviceReport" parameterType="com.xywg.admin.modular.report.model.DeviceReport">
      insert into buss_device_report (
          organization_code,
          project_code,
          team_sys_no,
          id_card_number,
          id_card_type,
          company_name,
          worker_name,
          project_name,
          team_name,
          time,
          total_count,
          total_date,
          	day01,
			day02,
			day03,
			day04,
			day05,
			day06,
			day07,
			day08,
			day09,
			day10,
			day11,
			day12,
			day13,
			day14,
			day15,
			day16,
			day17,
			day18,
			day19,
			day20,
			day21,
			day22,
			day23,
			day24,
			day25,
			day26,
			day27,
			day28,
			day29,
			day30,
			day31,
			total_time
      ) values (
          #{d.organizationCode},
          #{d.projectCode},
          #{d.teamSysNo},
          #{d.idCardNumber},
          #{d.idCardType},
          #{d.companyName},
          #{d.workerName},
          #{d.projectName},
          #{d.teamName},
          #{d.time},
          #{d.totalCount},
          #{d.totalDate},
          #{d.day01},
          #{d.day02},
          #{d.day03},
          #{d.day04},
          #{d.day05},
          #{d.day06},
          #{d.day07},
          #{d.day08},
          #{d.day09},
          #{d.day10},
          #{d.day11},
          #{d.day12},
          #{d.day13},
          #{d.day14},
          #{d.day15},
          #{d.day16},
          #{d.day17},
          #{d.day18},
          #{d.day19},
          #{d.day20},
          #{d.day21},
          #{d.day22},
          #{d.day23},
          #{d.day24},
          #{d.day25},
          #{d.day26},
          #{d.day27},
          #{d.day28},
          #{d.day29},
          #{d.day30},
          #{d.day31},
          #{d.totalTime}
       )
  	</insert>
  	
  	<!-- 更新数据 -->
  	<update id="updateDeviceReport" parameterType="com.xywg.admin.modular.report.model.DeviceReport">
		update buss_device_report set 
		total_count = #{d.totalCount}, 
		total_date = #{d.totalDate},
		day01 = #{d.day01}, 
		day02 = #{d.day02}, 
		day03 = #{d.day03}, 
		day04 = #{d.day04}, 
		day05 = #{d.day05}, 
		day06 = #{d.day06}, 
		day07 = #{d.day07}, 
		day08 = #{d.day08}, 
		day09 = #{d.day09}, 
		day10 = #{d.day10}, 
		day11 = #{d.day11}, 
		day12 = #{d.day12}, 
		day13 = #{d.day13}, 
		day14 = #{d.day14}, 
		day15 = #{d.day15}, 
		day16 = #{d.day16}, 
		day17 = #{d.day17}, 
		day18 = #{d.day18}, 
		day19 = #{d.day19}, 
		day20 = #{d.day20}, 
		day21 = #{d.day21}, 
		day22 = #{d.day22}, 
		day23 = #{d.day23}, 
		day24 = #{d.day24}, 
		day25 = #{d.day25}, 
		day26 = #{d.day26}, 
		day27 = #{d.day27}, 
		day28 = #{d.day28}, 
		day29 = #{d.day29}, 
		day30 = #{d.day30}, 
		day31 = #{d.day31},
		total_time=#{d.totalTime}
		where time = #{d.time} 
		and organization_code = #{d.organizationCode} 
		and project_code = #{d.projectCode} 
		<choose>
      	 	<when test="d.teamSysNo != null">
           		and team_sys_no = #{d.teamSysNo}
       		</when>
      	    <otherwise>
           		and team_sys_no is null
           	</otherwise>
        </choose> 
		and id_card_number = #{d.idCardNumber} 
		and id_card_type = #{d.idCardType} 
  	</update>
  	
  	<select id="getList" resultType="com.xywg.admin.modular.report.model.DeviceReportVo">
		select
		r.id,
		r.project_code AS projectCode,
		r.organization_code AS organizationCode,
		r.company_name AS companyName,
		r.id_card_type AS idCardType,
		r.id_card_number AS idCardNumber,
		r.worker_name AS workerName,
		r.project_name AS projectName,
		r.team_sys_no AS teamSysNo,
		r.team_name AS teamName,
		r.time,
		r.total_count AS totalCount,
		r.total_date AS totalDate,
		r.total_time AS totalTime,
		r.over_time AS overTime,
		r.rain,
		r.fall_ill as fallIll,
		r.compassionate_leave as compassionateLeave,
		r.absent,
		r.day01,
		r.day02,
		r.day03,
		r.day04,
		r.day05,
		r.day06,
		r.day07,
		r.day08,
		r.day09,
		r.day10,
		r.day11,
		r.day12,
		r.day13,
		r.day14,
		r.day15,
		r.day16,
		r.day17,
		r.day18,
		r.day19,
		r.day20,
		r.day21,
		r.day22,
		r.day23,
		r.day24,
		r.day25,
		r.day26,
		r.day27,
		r.day28,
		r.day29,
		r.day30,
		r.day31,
		d.name as idCardTypeName
		from
		buss_device_report  r
		LEFT JOIN sys_dict d on d.num=r.id_card_type and d.pid=(select s.id from sys_dict s where s.name='人员证件类型')
		where 
		r.organization_code in
		<foreach collection="map.ocList" open="(" close=")" separator="," item="item" index="index">
			#{item}
		</foreach>
		<if test="map.projectCode !=null  and  map.projectCode !=''  ">
			AND r.project_code = #{map.projectCode}
		</if>
		<if test="map.teamSysNo !=null  and  map.teamSysNo !=''  ">
			AND r.team_sys_no like CONCAT('%',#{map.teamSysNo},'%')
		</if>
		<if test="map.workerName !=null  and  map.workerName !=''  ">
			AND r.worker_name like CONCAT('%',#{map.workerName},'%')
		</if>
		<if test="map.chTime !=null  and  map.chTime !=''  ">
			AND r.time = #{map.chTime}
		</if>
		order by r.id DESC
	</select>


    <select id="getExportNewList" resultType="map">
        select

        id, project_code AS projectCode, organization_code AS organizationCode, company_name AS companyName,
        id_card_type AS idCardType, id_card_number AS idCardNumber, worker_name AS workerName, project_name AS projectName,
        team_sys_no AS teamSysNo, team_name AS teamName, time, total_count AS totalCount, total_date AS totalDate,
        rain,
        fall_ill as fallIll,
        compassionate_leave as compassionateLeave,
        absent,
        day01, day02, day03, day04, day05, day06, day07, day08, day09, day10, day11, day12, day13, day14, day15, day16, day17,
        day18, day19, day20, day21, day22, day23, day24, day25, day26, day27, day28, day29, day30, day31

        from
        buss_device_report
        where
        organization_code in
        <foreach collection="map.ocList" open="(" close=")" separator="," item="item" index="index">
            #{item}
        </foreach>
        <if test="map.projectCode !=null  and  map.projectCode !=''  ">
            AND project_code = #{map.projectCode}
        </if>
        <if test="map.teamSysNo !=null  and  map.teamSysNo !=''  ">
            AND team_sys_no like CONCAT('%',#{map.teamSysNo},'%')
        </if>
        <if test="map.workerName !=null  and  map.workerName !=''  ">
            AND worker_name like CONCAT('%',#{map.workerName},'%')
        </if>
        <if test="map.chTime !=null  and  map.chTime !=''  ">
            AND time = #{map.chTime}
        </if>
        order by id DESC
    </select>

	<select id="getExportList" resultType="map">
		select

		id, total_time totalTime,project_code AS projectCode, organization_code AS organizationCode, company_name AS companyName,
		id_card_type AS idCardType, id_card_number AS idCardNumber, worker_name AS workerName, project_name AS projectName,
		team_sys_no AS teamSysNo, team_name AS teamName, time, total_count AS totalCount, total_date AS totalDate,
		day01, day02, day03, day04, day05, day06, day07, day08, day09, day10, day11, day12, day13, day14, day15, day16, day17,
		day18, day19, day20, day21, day22, day23, day24, day25, day26, day27, day28, day29, day30, day31

		from
		buss_device_report
		where
		organization_code in
		<foreach collection="map.ocList" open="(" close=")" separator="," item="item" index="index">
			#{item}
		</foreach>
		<if test="map.projectCode !=null  and  map.projectCode !=''  ">
			AND project_code = #{map.projectCode}
		</if>
		<if test="map.teamSysNo !=null  and  map.teamSysNo !=''  ">
			AND team_sys_no like CONCAT('%',#{map.teamSysNo},'%')
		</if>
		<if test="map.workerName !=null  and  map.workerName !=''  ">
			AND worker_name like CONCAT('%',#{map.workerName},'%')
		</if>
		<if test="map.chTime !=null  and  map.chTime !=''  ">
			AND time = #{map.chTime}
		</if>
		order by id DESC
	</select>

	<update id="countTotalTime">
		UPDATE
buss_device_report
SET
total_time = (total_count + over_time) / #{workTime}
WHERE
id = #{id}
	</update>

	<update id="countTotalTimeByProjectCode">
UPDATE
		buss_device_report
SET
total_time = (total_count + over_time) / #{workTime}
WHERE
project_code = #{projectCode}
	</update>
</mapper>
