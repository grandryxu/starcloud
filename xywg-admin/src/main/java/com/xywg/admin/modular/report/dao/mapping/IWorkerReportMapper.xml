<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xywg.admin.modular.report.dao.IWorkerReportMapper">

  <!-- 工人不良信息列表查询  -->
	<select id="selectWorkerReport" resultType="map">
		select A.worker_name AS workerName,
		       A.cell_phone as cellPhone,
		       A.id_card_type as idCardType,
		       A.id_card_number as idCardNumber,
		       A.projectCount,B.badRecordsCount,
		       C.goodRecordsCount,D.blackListCount,
		       ifnull((E.sa_pay_amount+F.se_pay_amount), 0) as payAmount,
		       ifnull((E.sa_actual_amount+F.se_actual_amount), 0) AS actualAmount
		  from (SELECT t1.id_card_type,
		               t1.id_card_number,
						ifnull(count(t2.project_code), 0) as projectCount,
		               t1.worker_name,
		               t1.cell_phone
				  FROM (SELECT wm.id_card_type,
							   wm.id_card_number,
							   wm.worker_name,
							   wm.cell_phone
						  FROM buss_worker_master wm
						  JOIN buss_contractor_worker bcw
							ON bcw.id_card_type = wm.id_card_type
						   AND bcw.id_card_number = wm.id_card_number
						   AND bcw.organization_code IN
						   <foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
							   #{item}
						   </foreach>
						 where wm.is_del = 0
						   and bcw.is_del = 0
						 GROUP BY wm.id_card_type,
								  wm.id_card_number) t1
						  LEFT JOIN (SELECT pw.id_card_type,
											pw.id_card_number,
											pw.project_code
									   FROM buss_project_worker pw
									   JOIN buss_contractor_worker bcw
										 ON bcw.id_card_type = pw.id_card_type
										AND bcw.id_card_number = pw.id_card_number
										AND bcw.organization_code IN
										<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
											#{item}
										</foreach>
									  where pw.is_del = 0
										and bcw.is_del = 0
									  GROUP BY pw.id_card_type,
											   pw.id_card_number,
											   pw.project_code) t2
							ON t2.id_card_type = t1.id_card_type
						   AND t2.id_card_number = t1.id_card_number
						 GROUP BY id_card_type,
								  id_card_number) A
		  left join (SELECT t1.id_card_type,
		                    t1.id_card_number,
							ifnull(count(t4.id), 0) as badRecordsCount
					   FROM (SELECT wm.id_card_type,
								    wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
						      where wm.is_del = 0
								and bcw.is_del = 0
							  GROUP BY wm.id_card_type,
							           wm.id_card_number) t1
						LEFT JOIN buss_worker_bad_records t4
						  ON t4.id_card_type = t1.id_card_type
						 AND t4.id_card_number = t1.id_card_number
						 AND t4.type = 1
						 AND t4.is_audit = 2
					   where t4.is_del = 0
					   GROUP BY t1.id_card_type,
								t1.id_card_number) B
						  on A.id_card_type = B.id_card_type
						 and A.id_card_number = B.id_card_number
		  left join (SELECT t1.id_card_type,
						    t1.id_card_number,
							ifnull(count(t5.id), 0) as goodRecordsCount
					   FROM (SELECT wm.id_card_type,
									wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where wm.is_del = 0
								and bcw.is_del = 0
							  GROUP BY wm.id_card_type,
									   wm.id_card_number) t1
					   LEFT JOIN buss_worker_good_records t5
					     ON t5.id_card_type = t1.id_card_type
						AND t5.id_card_number = t1.id_card_number
						AND t5.type = 1
					  where t5.is_del = 0
					  GROUP BY t1.id_card_type,
							   t1.id_card_number) C
			on C.id_card_type = A.id_card_type
		   and C.id_card_number = A.id_card_number
		  left join (SELECT t1.id_card_type,
		                    t1.id_card_number,
							ifnull(count(t6.id), 0) as blackListCount
					   FROM (SELECT wm.id_card_type,
									wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where wm.is_del = 0
								and bcw.is_del = 0
							  GROUP BY wm.id_card_type,
									   wm.id_card_number) t1
					   LEFT JOIN buss_worker_black_list t6
					     ON t6.id_card_type = t1.id_card_type
						AND t6.id_card_number = t1.id_card_number
						AND t6.type = 1
					  where t6.is_del = 0
					  GROUP BY t1.id_card_type,
						       t1.id_card_number) D
		    on D.id_card_type = A.id_card_type
		   and D.id_card_number = A.id_card_number
		  left join (SELECT t1.id_card_type,
							t1.id_card_number,
							ifnull(sum(t7.pay_amount), 0) as sa_pay_amount,
							ifnull(sum(t7.actual_amount), 0) as sa_actual_amount
					   FROM (SELECT wm.id_card_type,
		                            wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where wm.is_del = 0
								and bcw.is_del = 0
							  GROUP BY wm.id_card_type,
									   wm.id_card_number) t1
					   LEFT JOIN buss_pay_roll_detail t7
					     ON t7.id_card_type = t1.id_card_type
						AND t7.id_card_number = t1.id_card_number
					   JOIN buss_pay_roll t8
					     ON t8.pay_roll_code = t7.pay_roll_code
						AND t8.save_status = 2
						AND t8.organization_code in
						<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
							#{item}
						</foreach>
					  where t7.is_del = 0
					    and t8.is_del = 0
					  group by t1.id_card_type,
					  		   t1.id_card_number) E
			on E.id_card_type = A.id_card_type
		   and E.id_card_number = A.id_card_number
		  left join (SELECT t1.id_card_type,
						    t1.id_card_number,
						    ifnull(sum(t9.settle_pay_amount), 0) AS se_pay_amount,
						    ifnull(sum(t9.settle_actual_amount), 0) AS se_actual_amount
					   FROM (SELECT wm.id_card_type,
									wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where wm.is_del = 0
								and bcw.is_del = 0
							  GROUP BY wm.id_card_type,
									   wm.id_card_number) t1
					   LEFT JOIN buss_settlement_detail t9
					     ON t9.id_card_type = t1.id_card_type
					   JOIN buss_settlement t10
					     ON t9.settlement_code = t10.settlement_code
					    AND t10.organization_code in
						<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
							#{item}
						</foreach>
						AND t9.id_card_number = t1.id_card_number
					  where t9.is_del = 0
					    and t10.is_del = 0
					  GROUP BY t1.id_card_type,
							   t1.id_card_number) F
            on F.id_card_type = A.id_card_type and F.id_card_number = A.id_card_number
		 where 1=1
		 <if test="map.workerName != null and map.workerName != ''">
			 AND A.worker_name like CONCAT('%',#{map.workerName},'%')
		 </if>
		 <if test="map.idCardNumber != null and map.idCardNumber != ''">
			 AND A.id_card_number like CONCAT('%',#{map.idCardNumber},'%')
		 </if>
		 <if test="map.cellPhone != null and map.cellPhone != ''">
			 AND A.cell_phone like CONCAT('%',#{map.cellPhone},'%')
		 </if>
	</select>

	<select id="getWorkerReport" resultType="com.xywg.admin.modular.report.model.WorkerReport">
		select A.worker_name AS workerName,
		       A.cell_phone as cellPhone,
		       A.id_card_type as idCardType,
		       A.id_card_number as idCardNumber,
		       A.projectCount,
		       B.badRecordsCount,
		       C.goodRecordsCount,
		       D.blackListCount ,
			   ifnull((E.sa_pay_amount + F.se_pay_amount), 0) as payAmount,
			   ifnull((E.sa_actual_amount + F.se_actual_amount), 0) AS actualAmount
		  from (SELECT t1.id_card_type,
					   t1.id_card_number,
						ifnull(count(t2.project_code), 0) as projectCount,
					   t1.worker_name,
					   t1.cell_phone
				  FROM (SELECT wm.id_card_type,
							   wm.id_card_number ,
							   wm.worker_name,
							   wm.cell_phone
						  FROM buss_worker_master wm
						  JOIN buss_contractor_worker bcw
						    ON bcw.id_card_type = wm.id_card_type
						   AND bcw.id_card_number = wm.id_card_number
						   AND bcw.organization_code IN
						   <foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
						       #{item}
						   </foreach>
					     where wm.is_del = 0
					       and bcw.is_del = 0
					     GROUP BY wm.id_card_type,
					              wm.id_card_number) t1
				  LEFT JOIN (SELECT pw.id_card_type,
								    pw.id_card_number,
								    pw.project_code
							   FROM buss_project_worker pw
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = pw.id_card_type
							    AND bcw.id_card_number = pw.id_card_number
							    AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where pw.is_del = 0
							    and bcw.is_del = 0
							  GROUP BY pw.id_card_type,
							  		   pw.id_card_number,
							  		   pw.project_code) t2
						ON t2.id_card_type = t1.id_card_type
					   AND t2.id_card_number = t1.id_card_number
					 GROUP BY id_card_type,
							  id_card_number) A
		  left join (SELECT t1.id_card_type,
					        t1.id_card_number,
							ifnull(count(t4.id), 0) as badRecordsCount
					   FROM (SELECT wm.id_card_type,
							        wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
							    AND bcw.id_card_number = wm.id_card_number
							    AND bcw.organization_code IN
							    <foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
								    #{item}
							    </foreach>
							  where wm.is_del = 0
		                        AND bcw.is_del = 0
							  GROUP BY wm.id_card_type,
							           wm.id_card_number) t1
					   LEFT JOIN buss_worker_bad_records t4
					     ON t4.id_card_type = t1.id_card_type
					    AND t4.id_card_number = t1.id_card_number
					    AND t4.type = 1
					    AND t4.is_audit = 2
					  where t4.is_del = 0
					  GROUP BY t1.id_card_type,
					           t1.id_card_number) B
		    on A.id_card_type = B.id_card_type
		   and A.id_card_number = B.id_card_number
		  left join (SELECT t1.id_card_type,
							t1.id_card_number,
							ifnull(count(t5.id), 0) as goodRecordsCount
					   FROM (SELECT wm.id_card_type,
								    wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
							    AND bcw.id_card_number = wm.id_card_number
							    AND bcw.organization_code IN
							    <foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
								    #{item}
							    </foreach>
							  where wm.is_del = 0
								AND bcw.is_del = 0
							  GROUP BY wm.id_card_type,
							           wm.id_card_number) t1
					   LEFT JOIN buss_worker_good_records t5
					     ON t5.id_card_type = t1.id_card_type
					    AND t5.id_card_number = t1.id_card_number
					    AND t5.type = 1
					  where t5.is_del = 0
					  GROUP BY t1.id_card_type,
					           t1.id_card_number) C
			on C.id_card_type = A.id_card_type
		   and C.id_card_number = A.id_card_number
		  left join (SELECT t1.id_card_type,
							t1.id_card_number,
							ifnull(count(t6.id), 0) as blackListCount
					   FROM (SELECT wm.id_card_type,
								    wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where wm.is_del = 0
							    AND bcw.is_del = 0
							  GROUP BY wm.id_card_type,
								       wm.id_card_number) t1
					   LEFT JOIN buss_worker_black_list t6
					     ON t6.id_card_type = t1.id_card_type
					    AND t6.id_card_number = t1.id_card_number
					    AND t6.type = 1
					  where t6.is_del = 0
					  GROUP BY t1.id_card_type, t1.id_card_number) D
		    on D.id_card_type = A.id_card_type
		   and D.id_card_number = A.id_card_number
		  left join (SELECT t1.id_card_type,
							t1.id_card_number,
							ifnull(sum(t7.pay_amount), 0) as sa_pay_amount,
							ifnull(sum(t7.actual_amount), 0) as sa_actual_amount
					   FROM (SELECT wm.id_card_type,
							        wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
								AND bcw.id_card_number = wm.id_card_number
								AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
								    #{item}
								</foreach>
							  where wm.is_del = 0
								AND bcw.is_del = 0
							  GROUP BY wm.id_card_type,
							           wm.id_card_number) t1
					   LEFT JOIN buss_pay_roll_detail t7
					     ON t7.id_card_type = t1.id_card_type
						AND t7.id_card_number = t1.id_card_number
					   JOIN buss_pay_roll t8
					     ON t8.pay_roll_code = t7.pay_roll_code
						AND t8.save_status = 2
						AND t8.organization_code in
						<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
							#{item}
						</foreach>
						where t7.is_del = 0
						  and t8.is_del = 0
						group by t1.id_card_type,
						         t1.id_card_number) E
			on E.id_card_type = A.id_card_type
		   and E.id_card_number = A.id_card_number
		  left join (SELECT t1.id_card_type,
						    t1.id_card_number,
						    ifnull(sum(t9.settle_pay_amount), 0) AS se_pay_amount,
					        ifnull(sum(t9.settle_actual_amount), 0) AS se_actual_amount
					   FROM (SELECT wm.id_card_type,
								    wm.id_card_number
							   FROM buss_worker_master wm
							   JOIN buss_contractor_worker bcw
							     ON bcw.id_card_type = wm.id_card_type
							    AND bcw.id_card_number = wm.id_card_number
							    AND bcw.organization_code IN
								<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
									#{item}
								</foreach>
							  where wm.is_del = 0
							    and bcw.is_del = 0
							  GROUP BY wm.id_card_type, wm.id_card_number) t1
					   LEFT JOIN buss_settlement_detail t9
					     ON t9.id_card_type = t1.id_card_type
					   JOIN buss_settlement t10
					     ON t9.settlement_code = t10.settlement_code
					    AND t10.organization_code in
						<foreach collection="map.depts" item="item" index="index" open="(" separator="," close=")">
							#{item}
						</foreach>
					    AND t9.id_card_number = t1.id_card_number
					  where t9.is_del = 0
		                AND t10.is_del = 0
					  GROUP BY t1.id_card_type, t1.id_card_number) F
		    on F.id_card_type = A.id_card_type
		   and F.id_card_number = A.id_card_number
		 where 1=1
		 <if test="map.workerName != null and map.workerName != ''">
		     AND A.worker_name like CONCAT('%',#{map.workerName},'%')
		 </if>
		 <if test="map.idCardNumber != null and map.idCardNumber != ''">
			 AND A.id_card_number like CONCAT('%',#{map.idCardNumber},'%')
		 </if>
		 <if test="map.cellPhone != null and map.cellPhone != ''">
			 AND A.cell_phone like CONCAT('%',#{map.cellPhone},'%')
		 </if>
	</select>
</mapper>